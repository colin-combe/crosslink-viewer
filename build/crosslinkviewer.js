var xiNET={svgns:"http://www.w3.org/2000/svg",xlinkNS:"http://www.w3.org/1999/xlink",linkWidth:1.3,homodimerLinkWidth:1.3};xiNET.highlightColour=new RGBColor("#fdc086");xiNET.selectedColour=new RGBColor("#ffff99");xiNET.defaultSelfLinkColour=new RGBColor("#9970ab");xiNET.defaultInterLinkColour=new RGBColor("#35978f");xiNET.homodimerLinkColour=new RGBColor("#a50f15");
xiNET.Controller=function(a){"string"===typeof a&&(a=document.getElementById(a));d3.select(a).selectAll("*").remove();var c=document.createElementNS("http://www.w3.org/1999/xhtml","div");c.setAttribute("style","width:100%;height:100%;display:block;");a.appendChild(c);this.svgElement=document.createElementNS(xiNET.svgns,"svg");this.svgElement.setAttribute("id","networkSVG");this.svgElement.setAttribute("width","100%");this.svgElement.setAttribute("height","100%");this.svgElement.oncontextmenu=function(){return!1};
var b=this;this.svgElement.onmousedown=function(a){b.mouseDown(a)};this.svgElement.onmousemove=function(a){b.mouseMove(a)};this.svgElement.onmouseup=function(a){b.mouseUp(a)};this.svgElement.onmouseout=function(a){b.hideTooltip(a)};a=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";document.attachEvent?this.svgElement.attachEvent("on"+a,function(a){b.mouseWheel(a)}):document.addEventListener&&this.svgElement.addEventListener(a,function(a){b.mouseWheel(a)},!1);this.lastMouseUp=(new Date).getTime();
this.svgElement.ontouchstart=function(a){b.touchStart(a)};this.svgElement.ontouchmove=function(a){b.touchMove(a)};this.svgElement.ontouchend=function(a){b.touchEnd(a)};this.linkSelectionCallbacks=[];this.linkHighlightsCallbacks=[];this.legendCallbacks=[];c.appendChild(this.svgElement);this.ambigShown=this.selfLinksShown=!0;c=document.createElementNS(xiNET.svgns,"rect");c.setAttribute("id","background_fill");c.setAttribute("x",0);c.setAttribute("y",0);c.setAttribute("width",5120);c.setAttribute("height",
4096);c.setAttribute("fill-opacity","1");c.setAttribute("fill","#FFFFFF");this.svgElement.appendChild(c);this.container=document.createElementNS(xiNET.svgns,"g");this.container.setAttribute("id","container");this.p_pLinksWide=document.createElementNS(xiNET.svgns,"g");this.p_pLinksWide.setAttribute("id","p_pLinksWide");this.container.appendChild(this.p_pLinksWide);this.proteinLower=document.createElementNS(xiNET.svgns,"g");this.proteinLower.setAttribute("id","proteinLower");this.container.appendChild(this.proteinLower);
this.highlights=document.createElementNS(xiNET.svgns,"g");this.highlights.setAttribute("class","highlights");this.container.appendChild(this.highlights);this.res_resLinks=document.createElementNS(xiNET.svgns,"g");this.res_resLinks.setAttribute("id","res_resLinks");this.container.appendChild(this.res_resLinks);this.p_pLinks=document.createElementNS(xiNET.svgns,"g");this.p_pLinks.setAttribute("id","p_pLinks");this.container.appendChild(this.p_pLinks);this.proteinUpper=document.createElementNS(xiNET.svgns,
"g");this.proteinUpper.setAttribute("id","proteinUpper");this.container.appendChild(this.proteinUpper);this.svgElement.appendChild(this.container);this.tooltip=document.createElementNS(xiNET.svgns,"text");this.tooltip.setAttribute("x",0);this.tooltip.setAttribute("y",0);c=document.createTextNode("tooltip");this.tooltip.appendChild(c);this.tooltip_bg=document.createElementNS(xiNET.svgns,"rect");this.tooltip_bg.setAttribute("class","tooltip_bg");this.tooltip_bg.setAttribute("fill-opacity",.75);this.tooltip_bg.setAttribute("stroke-opacity",
1);this.tooltip_bg.setAttribute("stroke-width",1);this.tooltip_subBg=document.createElementNS(xiNET.svgns,"rect");this.tooltip_subBg.setAttribute("fill","white");this.tooltip_subBg.setAttribute("stroke","white");this.tooltip_subBg.setAttribute("class","tooltip_bg");this.tooltip_subBg.setAttribute("opacity",1);this.tooltip_subBg.setAttribute("stroke-width",1);this.svgElement.appendChild(this.tooltip_subBg);this.svgElement.appendChild(this.tooltip_bg);this.svgElement.appendChild(this.tooltip);this.xiNET_storage=
new xiNET_Storage(this);this.clear()};
xiNET.Controller.prototype.clear=function(){this.sequenceInitComplete=!1;this.force&&this.force.stop();this.force=null;d3.select(this.p_pLinksWide).selectAll("*").remove();d3.select(this.highlights).selectAll("*").remove();d3.select(this.p_pLinks).selectAll("*").remove();d3.select(this.res_resLinks).selectAll("*").remove();d3.select(this.proteinLower).selectAll("*").remove();d3.select(this.proteinUpper).selectAll("*").remove();this.panning=!1;this.dragElement=null;this.dragging=!1;this.dragStart=
{};this.rotating=!1;this.proteins=d3.map();this.proteinLinks=d3.map();this.matches=[];this.groups=d3.set();this.subgraphs=[];this.proteinCount=this.layoutXOffset=0;this.unambigLinkFound=!1;this.maxBlobRadius=30;Protein.MAXSIZE=100;this.layout=null;this.z=1;this.scores=null;this.selectedLinks=d3.map();this.hideTooltip();this.resetZoom();this.state=xiNET.Controller.MOUSE_UP};xiNET.setCTM=function(a,c){a.setAttribute("transform","matrix("+c.a+","+c.b+","+c.c+","+c.d+","+c.e+","+c.f+")")};
xiNET.Controller.prototype.linkSelectionChanged=function(){for(var a=this.linkSelectionCallbacks,c=a.length,b=0;b<c;b++)a[b](this.selectedLinks)};xiNET.Controller.prototype.linkHighlightsChanged=function(a){for(var c=this.linkHighlightsCallbacks,b=c.length,d=0;d<b;d++)c[d](a)};xiNET.Controller.prototype.legendChanged=function(){for(var a=this.legendCallbacks,c=a.length,b=0;b<c;b++)a[b](this.linkColours,this.domainColours)};
xiNET.Controller.prototype.clearSelection=function(){for(var a=this.selectedLinks.values(),c=a.length,b=0;b<c;b++)a[b].setSelected(!1)};
xiNET.Controller.prototype.setAnnotations=function(a){function c(){var a=d3.set();for(e=0;e<d;e++)for(var c=b[e],g=0;g<c.annotations.length;g++)a.add(c.annotations[g].name);c=a.values().length;3>c&&(c=3);9>c?(c=colorbrewer.Accent[c].slice().reverse(),f.domainColours=d3.scale.ordinal().range(c)):13>c?(c=colorbrewer.Set3[c].slice().reverse(),f.domainColours=d3.scale.ordinal().range(c)):f.domainColours=d3.scale.category20();for(e=0;e<d;e++)for(c=b[e],g=0;g<c.annotations.length;g++){var a=c.annotations[g],
h=f.domainColours(a.name);a.pieSlice.setAttribute("fill",h);a.pieSlice.setAttribute("stroke",h);a.colouredRect.setAttribute("fill",h);a.colouredRect.setAttribute("stroke",h)}f.legendChanged()}this.annotationChoice=a;for(var b=this.proteins.values(),d=b.length,e=0;e<d;e++)b[e].clearPositionalFeatures();this.domainColours=null;this.legendChanged();if(this.sequenceInitComplete){var f=this;if("CUSTOM"===a.toUpperCase()){for(e=0;e<d;e++)a=b[e],a.setPositionalFeatures(a.customAnnotations);c()}else if("LYSINES"===
a.toUpperCase()){for(e=0;e<d;e++){a=b[e];for(var g=a.sequence,h=[],k=0;k<a.size;k++)"K"===g[k]&&h.push(new Annotation("Lysine",k+1,k+1));a.setPositionalFeatures(h)}c()}else if("SUPERFAM"===a.toUpperCase()||"SUPERFAMILY"===a.toUpperCase())for(var m=0,e=0;e<d;e++)a=b[e],this.xiNET_storage.getSuperFamFeatures(a.id,function(a,b){f.proteins.get(a).setPositionalFeatures(b);m++;m===d&&c()});else if("UNIPROT"===a.toUpperCase()||"UNIPROTKB"===a.toUpperCase())for(e=m=0;e<d;e++)a=b[e],this.xiNET_storage.getUniProtFeatures(a.id,
function(a,b){var e=f.proteins.get(a);if(-1===e.accession.indexOf("-")||"P02768-A"===e.accession){if("P02768-A"===e.accession)for(var g=0;g<b.length;g++){var h=b[g];h.start+=-24;h.end+=-24}e.setPositionalFeatures(b)}m++;m===d&&c()})}};
xiNET.Controller.prototype.initLayout=function(){for(var a=this.proteins.values(),c=a.length,b=Protein.MAXSIZE=0;b<c;b++){var d=a[b].size;d>Protein.MAXSIZE&&(Protein.MAXSIZE=d)}Protein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-Protein.LABELMAXLENGTH)/Protein.MAXSIZE;a=this.groups.values().length;if(1<a){this.groups.values();this.linkColours=d3.scale.ordinal().range(colorbrewer.Dark2[5]);c=this.groups.values();for(b=0;b<a;b++)this.linkColours(c[b]);this.legendChanged()}if("undefined"!==
typeof this.layout&&null!=this.layout)this.loadLayout();else{a=this.proteins.values();c=a.length;for(b=0;b<c;b++)d=a[b],this.proteinLower.appendChild(d.lowerGroup),this.proteinUpper.appendChild(d.upperGroup);this.autoLayout()}};
xiNET.Controller.prototype.initProteins=function(){for(var a=this.proteins.values(),c=a.length,b=Protein.MAXSIZE=0;b<c;b++){var d=a[b].size;d>Protein.MAXSIZE&&(Protein.MAXSIZE=d)}Protein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-Protein.LABELMAXLENGTH)/Protein.MAXSIZE;for(b=0;b<c;b++)a[b].init();this.sequenceInitComplete=!0;this.annotationSet?xlv.setAnnotations(this.annotationSet):this.setAnnotations("CUSTOM")};
xiNET.Controller.prototype.reset=function(){this.resetZoom();for(var a=this.proteins.values(),c=a.length,b=0;b<c;b++){var d=a[b];!1===d.isParked&&d.setForm(0)}this.autoLayout()};xiNET.Controller.prototype.resetZoom=function(){this.container.setAttribute("transform","scale(1)");this.scale()};
xiNET.Controller.prototype.getSVG=function(){var a=this.svgElement.parentNode.innerHTML.replace(/<rect .*?\/rect>/i,""),a=a.replace("<svg ",'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events" '+('viewBox="0 0 '+this.svgElement.parentNode.clientWidth+" "+this.svgElement.parentNode.clientHeight+'" '));return'<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+
a};xiNET.Controller.bestId=function(a){return a.accession?a.accession:a.name?a.name:a.id};xiNET.Controller.prototype.addProtein=function(a,c,b,d){c=new Protein(a,this,d,c);c.setSequence(b);this.proteins.set(a,c)};xiNET.Controller.prototype.addMatch=function(a,c,b,d,e,f,g,h,k,m,l,n,s,u,w){return new Match(this,a,c,b,d,e,f,g,h,k,m,l,n,s,u,w)};
xiNET.Controller.prototype.addMatches=function(a){for(var c=a.length,b=0;b<c;b++)this.addMatch(a[b][0],a[b][1],a[b][2],a[b][3],a[b][4],a[b][5],a[b][6],a[b][7],a[b][8],a[b][9],a[b][10],a[b][11],a[b][12],a[b][13],a[b][14],a[b][15])};
xiNET.Controller.prototype.addAnnotation=function(a,c,b,d,e){if(a=this.proteins.get(a)){b=parseInt(b);d=parseInt(d);isNaN(b)&&isNaN(d)?(b=1,d=a.size):isNaN(b)?b=d:isNaN(d)&&(d=b);if(b>d){var f=b;b=d;d=f}c=new Annotation(c,b,d,e);null==a.customAnnotations&&(a.customAnnotations=[]);a.customAnnotations.push(c)}};xiNET.Controller.prototype.addAnnotationByName=function(a,c,b,d,e){for(var f=this.proteins.values(),g=f.length,h=0;h<g;h++){var k=f[h];k.name==a&&this.addAnnotation(k.id,c,b,d,e)}};
xiNET.Controller.prototype.addAnnotations=function(a){a=d3.csv.parseRows(a);for(var c=a[0],b=0;b<c.length;b++)c[b]=c[b].trim();var b=c.indexOf("ProteinId"),d=c.indexOf("AnnotName");-1===d&&(d=c.indexOf("Name"));var e=c.indexOf("StartRes");-1===e&&(e=c.indexOf("StartResidue"));var f=c.indexOf("EndRes");-1===f&&(f=c.indexOf("EndResidue"));var g=c.indexOf("Color");-1===g&&(g=c.indexOf("Colour"));for(var c=a.length,h=1;h<c;h++)this.addAnnotation(a[h][b],a[h][d],a[h][e],a[h][f],a[h][g])};
xiNET.Controller.prototype.getLayout=function(){return JSON.stringify(this.proteins.values(),null,"\t").replace(/\\u0000/gi,"")};xiNET.Controller.prototype.setLayout=function(a){this.layout="object"!==typeof a?JSON.parse(decodeURIComponent(a)):a};
xiNET.Controller.prototype.loadLayout=function(){for(var a in this.layout){var c=this.layout[a],b=this.proteins.get(c.id);void 0!==b?(this.proteinLower.appendChild(b.lowerGroup),this.proteinUpper.appendChild(b.upperGroup),b.setPosition(c.x,c.y),"undefined"!==typeof c.rot&&(b.rotation=c.rot-0),c.form&&(b.stickZoom=1,b.form=c.form-0),"undefined"!==typeof c.parked&&b.setParked(c.parked),c.flipped&&b.toggleFlipped()):console.log("!")}for(var c=this.proteins.values(),b=c.length,d=0;d<b;d++)a=c[d],null==
a.x&&(a.toBlob(),a.setPosition(20,20),this.proteinLower.appendChild(a.lowerGroup),this.proteinUpper.appendChild(a.upperGroup))};xiNET.Controller.prototype.setLinkColour=function(a,c){var b=this.proteinLinks.get(a);"undefined"!==typeof b?(b.colour=new RGBColor(c),b.colourSpecified=!0):(b=this.proteins.get(a),"undefined"!==typeof b&&(b.internalLinkColour=new RGBColor(c)))};
xiNET.Controller.prototype.parkAll=function(){for(var a=this.proteins.values(),c=a.length,b=0;b<c;b++){var d=a[b];!1===d.isParked&&d.toggleParked()}};xiNET.Controller.prototype.setCutOff=function(a){this.cutOff=a;this.checkLinks()};xiNET.Controller.prototype.showSelfLinks=function(a){this.selfLinksShown=a;this.checkLinks()};xiNET.Controller.prototype.showAmbig=function(a){this.ambigShown=a;this.checkLinks()};xiNET.Controller.MOUSE_UP=0;xiNET.Controller.PANNING=1;xiNET.Controller.DRAGGING=2;xiNET.Controller.ROTATING=3;xiNET.Controller.SCALING_PROTEIN=4;xiNET.Controller.SCALING_ALL_PROTEINS=5;xiNET.Controller.SELECTING=6;
xiNET.Controller.prototype.mouseDown=function(a){a.preventDefault();"undefined"!==typeof this.force&&null!=this.force&&this.force.stop();var c=this.getEventPoint(a);this.dragStart=this.mouseToSVG(c.x,c.y);var b;a.which?b=3===a.which:a.button&&(b=2===a.button);!0===a.ctrlKey||!0===a.shiftKey||b||(this.state=xiNET.Controller.PANNING,this.panned=!1);return!1};
xiNET.Controller.prototype.mouseMove=function(a){var c=this.getEventPoint(a);a=this.mouseToSVG(c.x,c.y);if(null!=this.dragElement){this.hideTooltip();var b=this.dragStart.x-a.x,d=this.dragStart.y-a.y;if(this.state===xiNET.Controller.DRAGGING){var e,f;if("undefined"===typeof this.dragElement.x){var g;g=this.dragElement.fromProtein?this.dragElement.fromProtein:this.dragElement.proteinLink.fromProtein;for(var h=this.proteins.values(),k=h.length,c=0;c<k;c++)h[c].subgraph=null;c=g.getSubgraph().nodes.values();
g=c.length;for(h=0;h<g;h++)k=c[h],e=k.x,f=k.y,e-=b,f-=d,k.setPosition(e,f),k.setAllLineCoordinates();for(h=0;h<g;h++)c[h].setAllLineCoordinates()}else e=this.dragElement.x,f=this.dragElement.y,this.dragElement.setPosition(e-b,f-d),this.dragElement.setAllLineCoordinates();this.dragStart=a}else this.state===xiNET.Controller.ROTATING?(a=Math.atan2(a.y-this.dragElement.y,a.x-this.dragElement.x),0===this.whichRotator&&(a+=Math.PI),this.dragElement.setRotation(360/(2*Math.PI)*a),this.dragElement.setAllLineCoordinates()):
Math.sqrt(b*b+d*d)>5*this.z&&(this.state=xiNET.Controller.DRAGGING)}else this.state===xiNET.Controller.PANNING?xiNET.setCTM(this.container,this.container.getCTM().translate(a.x-this.dragStart.x,a.y-this.dragStart.y)):this.showTooltip(c);return!1};
xiNET.Controller.prototype.mouseUp=function(a){var c=(new Date).getTime();this.preventDefaultsAndStopPropagation(a);if(150<c-this.lastMouseUp){var b,d;a.which?b=3===a.which:a.button&&(b=2===a.button);a.which?d=2===a.which:a.button&&(d=1===a.button);var e=this.getEventPoint(a),e=this.mouseToSVG(e.x,e.y);if(null!=this.dragElement)this.state!==xiNET.Controller.DRAGGING&&this.state!==xiNET.Controller.ROTATING?b?"undefined"===typeof this.dragElement.x?1==this.dragElement.selfLink()?this.dragElement.proteinLink&&
this.dragElement.proteinLink.fromProtein.toggleFlipped():(void 0!==this.dragElement.hidden?this.dragElement.hidden=!0:this.dragElement.proteinLink.hidden=!0,this.dragElement.highlightLine.setAttribute("stroke-opacity","0"),this.checkLinks()):this.dragElement.setParked(!this.dragElement.isParked,e):d||"undefined"!==typeof this.dragElement.x&&(a.shiftKey?this.dragElement.switchStickScale(e):!0===this.sequenceInitComplete&&(1===this.dragElement.form?this.dragElement.setForm(0,e):this.dragElement.setForm(1,
e))):this.state===xiNET.Controller.ROTATING&&this.dragElement.setRotation(5*Math.round(this.dragElement.rotation/5));else if(b){a=this.proteinLinks.values();b=a.length;for(d=0;d<b;d++)a[d].hidden=!1;this.checkLinks()}else!1===a.ctrlKey&&this.clearSelection();this.state===xiNET.Controller.SELECTING&&(clearInterval(this.marcher),this.svgElement.removeChild(this.marquee))}this.dragElement=null;this.whichRotator=-1;this.state=xiNET.Controller.MOUSE_UP;this.lastMouseUp=c;return!1};
xiNET.Controller.prototype.updateMarquee=function(a,c){var b=this.dragStart,d=[b.x,c.x].sort(sortByNumber),b=[b.y,c.y].sort(sortByNumber);a.setAttribute("x",d[0]);a.setAttribute("y",b[0]);a.setAttribute("width",d[1]-d[0]);a.setAttribute("height",b[1]-b[0])};function sortByNumber(a,c){return a-c}
xiNET.Controller.prototype.mouseWheel=function(a){this.preventDefaultsAndStopPropagation(a);var c=1+(a.wheelDelta?a.wheelDelta/3600:a.detail/-90),b=this.container;a=this.getEventPoint(a);a=this.mouseToSVG(a.x,a.y);c=this.svgElement.createSVGMatrix().translate(a.x,a.y).scale(c).translate(-a.x,-a.y);xiNET.setCTM(b,b.getCTM().multiply(c));this.scale();return!1};
xiNET.Controller.prototype.getEventPoint=function(a){var c=this.svgElement.createSVGPoint(),b=this.svgElement.parentNode,d=0,e=0;do d+=b.offsetTop||0,e+=b.offsetLeft||0,b=b.offsetParent;while(b);c.x=a.pageX-e;c.y=a.pageY-d;return c};xiNET.Controller.prototype.mouseToSVG=function(a,c){var b=this.svgElement.createSVGPoint();b.x=a;b.y=c;return b=b.matrixTransform(this.container.getCTM().inverse())};
xiNET.Controller.prototype.preventDefaultsAndStopPropagation=function(a){a.stopPropagation&&a.stopPropagation();null!=a.cancelBubble&&(a.cancelBubble=!0);a.preventDefault&&a.preventDefault()};xiNET.Controller.prototype.touchStart=function(a){a.preventDefault();"undefined"!==typeof this.force&&null!=this.force&&this.force.stop();a=this.getTouchEventPoint(a);this.dragStart=this.mouseToSVG(a.x,a.y);this.state=xiNET.Controller.PANNING};
xiNET.Controller.prototype.touchMove=function(a){this.preventDefaultsAndStopPropagation(a);if(this.sequenceInitComplete){var c=this.getTouchEventPoint(a);a=this.mouseToSVG(c.x,c.y);if(null!=this.dragElement){this.hideTooltip();var b=this.dragStart.x-a.x,d=this.dragStart.y-a.y;if(this.state===xiNET.Controller.DRAGGING){var e,f;if("undefined"===typeof this.dragElement.x){var g;g=this.dragElement.fromProtein?this.dragElement.fromProtein:this.dragElement.proteinLink.fromProtein;for(var h=this.proteins.values(),
k=h.length,c=0;c<k;c++)h[c].subgraph=null;c=g.getSubgraph().nodes.values();g=c.length;for(h=0;h<g;h++)k=c[h],e=k.x,f=k.y,e-=b,f-=d,k.setPosition(e,f),k.setAllLineCoordinates();for(h=0;h<g;h++)c[h].setAllLineCoordinates()}else e=this.dragElement.x,f=this.dragElement.y,this.dragElement.setPosition(e-b,f-d),this.dragElement.setAllLineCoordinates();this.dragStart=a}else this.state===xiNET.Controller.ROTATING?(a=Math.atan2(a.y-this.dragElement.y,a.x-this.dragElement.x),0===this.whichRotator&&(a+=Math.PI),
this.dragElement.setRotation(360/(2*Math.PI)*a),this.dragElement.setAllLineCoordinates()):Math.sqrt(b*b+d*d)>5*this.z&&(this.state=xiNET.Controller.DRAGGING)}else xiNET.setCTM(this.container,this.container.getCTM().translate(a.x-this.dragStart.x,a.y-this.dragStart.y))}return!1};
xiNET.Controller.prototype.touchEnd=function(a){this.preventDefaultsAndStopPropagation(a);null!=this.dragElement?this.state!==xiNET.Controller.DRAGGING&&this.state!==xiNET.Controller.ROTATING?"undefined"!==typeof this.dragElement.x&&(0===this.dragElement.form?this.dragElement.setForm(1):this.dragElement.setForm(0)):this.state===xiNET.Controller.ROTATING&&this.dragElement.setRotation(5*Math.round(this.dragElement.rotation/5)):!1===a.ctrlKey&&this.clearSelection();this.state===xiNET.Controller.SELECTING&&
(clearInterval(this.marcher),this.svgElement.removeChild(this.marquee));this.dragElement=null;this.whichRotator=-1;this.state=xiNET.Controller.MOUSE_UP;return!1};xiNET.Controller.prototype.getTouchEventPoint=function(a){var c=this.svgElement.createSVGPoint(),b=this.svgElement.parentNode,d=0,e=0;do d+=b.offsetTop||0,e+=b.offsetLeft||0,b=b.offsetParent;while(b);c.x=a.touches[0].pageX-e;c.y=a.touches[0].pageY-d;return c};xiNET.Controller.prototype.autoLayout=function(){function a(a){function b(a){c.push(a.id);for(var d=0;d<a.proteinLinks.values().length;d++){var e=a.proteinLinks.values()[d];if(!0===e.check()&&(e=e.getOtherEnd(a),-1===c.indexOf(e.id))){b(e);break}}}var c=[];b(function(){for(var b=a.nodes.values(),c=b.length,d=0;d<c;d++)if(2>b[d].countExternalLinks())return b[d];console.error("missed linear subgraph start");return null}());return c}function c(a){return a*(60+Protein.LABELMAXLENGTH)-30}this.force&&this.force.stop();
for(var b=this.svgElement.parentNode.clientWidth,d=this.svgElement.parentNode.clientHeight,e=this,f=this.proteins.values(),g=f.length,h=this.subgraphs.length=0;h<g;h++)f[h].subgraph=null;for(h=0;h<g;h++)f[h].getSubgraph();this.subgraphs.sort(function(a,b){return a.nodes.values().length-b.nodes.values().length});if(1===g){var k=f[0];k.setPosition(b/2,d/4*3)}else if(2===g)k=f[0],k.setPosition(b/2,.3*d),k.setAllLineCoordinates(),f=f[1],f.setPosition(b/2,.6*d),f.setAllLineCoordinates();else{for(var m=
[],f=[],h=this.subgraphs.length,k=0;k<h;k++){var l=this.subgraphs[k],n=l.nodes.values(),s=n.length,u=!0;if(1===s)u=!0;else{for(var w=!1,t=0;t<s;t++)if(2<n[t].countExternalLinks()){u=!1;break}else 2>n[t].countExternalLinks()&&(w=!0);w||(u=!1)}!0===u?m.push(l):f.push(l)}var w=u=l=0,z=-1;if(0<m.length)for(l++,k=0;k<m.length;k++)for(n=m[k].nodes.keys(),s=n.length,2<s&&(n=a(m[k])),t=0;t<s;t++){var h=this.proteins.get(n[t]),x,A;!0===h.isParked?(w++,x=c(z),A=30*w,A>d&&(z--,w=1,x=c(z),A=30*w)):(u++,(60>g||
1<s)&&u++,x=c(l),A=30*u,30*(u+2*(s-1-t))+this.maxBlobRadius>d&&(l++,u=1,60>g&&u++,x=c(l),A=30*u));h.setPosition(x,A);h.setAllLineCoordinates()}this.layoutXOffset=c(l+.5);if("undefined"===typeof this.force||null==this.force){g={NAME:"ALL",children:[]};for(k=0;k<f.length;k++)for(n=f[k].nodes.values(),s=n.length,t=0;t<s;t++)h=this.proteins.get(n[t].id),l={},l.id=h.id,l.x=h.x-this.layoutXOffset,l.y=h.y,l.px=h.x-this.layoutXOffset,l.py=h.y,l.linkCount=h.proteinLinks.keys().length,l.size=30,g.children.push(l);
n=d3.layout.pack().size([b-this.layoutXOffset,d]).value(function(a){return a.size}).sort(function(a,b){return b.linkCount-a.linkCount}).nodes(g);s=n.length;for(t=1;t<s;t++)g=n[t],k=this.proteins.get(g.id),g=Protein.rotatePointAboutPoint([g.x,g.y],[b-this.layoutXOffset/2,d/2],90),k.setPosition(g[0]+this.layoutXOffset,g[1]),k.setAllLineCoordinates(!1)}m=b-this.layoutXOffset;200>m&&(m=b);g={nodes:[],links:[]};b={};for(k=u=0;k<f.length;k++)for(n=f[k].nodes.values(),s=n.length,t=0;t<s;t++)h=this.proteins.get(n[t].id),
b[h.id]=u,u++,l={},l.id=h.id,l.x=h.x-this.layoutXOffset,l.y=h.y,l.px=h.x-this.layoutXOffset,l.py=h.y,g.nodes.push(l);for(k=0;k<f.length;k++)for(n=f[k].links.values(),t=n.length,h=0;h<t;h++)if(l=n[h],u=l.fromProtein,w=l.toProtein)u=b[u.id],w=b[w.id],u!==w&&("undefined"!==typeof u&&"undefined"!==typeof w?(z={},z.source=u,z.target=w,z.id=l.id,g.links.push(z)):alert("NOT RIGHT"));f=Math.sqrt(g.nodes.length/(m*d));this.force=d3.layout.force().nodes(g.nodes).links(g.links).gravity(85*f).linkDistance(60).charge(-30/
f).size([m,d]);s=this.force.nodes().length;this.force.links();this.force.on("tick",function(a){a=e.force.nodes();for(var b=0;b<s;b++){var c=a[b],d=e.proteins.get(c.id);d.setPosition(c.x+e.layoutXOffset,c.y);d.setAllLineCoordinates()}});this.force.start()}};xiNET.Controller.prototype.checkLinks=function(){for(var a=this.proteinLinks.values(),c=a.length,b=0;b<c;b++)a[b].check();this.linkSelectionChanged()};
xiNET.Controller.prototype.scale=function(){this.z=this.container.getScreenCTM().inverse().a;for(var a=this.proteins.values(),c=a.length,b=0;b<c;b++){var d=a[b];d.setPosition(d.x,d.y);0!==d.form&&d.setAllLineCoordinates()}a=this.proteinLinks.values();c=a.length;for(b=0;b<c;b++)if(d=a[b],d.fromProtein!==d.toProtein&&null!==d.toProtein&&!d.fromProtein.isParked&&!d.toProtein.isParked)if(0===d.fromProtein.form&&0===d.toProtein.form)d.line.setAttribute("stroke-width",this.z*xiNET.linkWidth),d.highlightLine.setAttribute("stroke-width",
10*this.z),d.fatLine.setAttribute("stroke-width",this.z*d.w),d.ambig&&d.dashedLine(!0);else for(var e=d.residueLinks.keys().length,f=0;f<e;f++){var g=d.residueLinks.values()[f];g.check()&&(d.residueLinks.values()[f].line.setAttribute("stroke-width",this.z*xiNET.linkWidth),d.residueLinks.values()[f].highlightLine.setAttribute("stroke-width",10*this.z),g.ambig&&g.dashedLine(!0))}};xiNET.Controller.prototype.showTooltip=function(a){var c;c=this.tooltip.getComputedTextLength()+16;var b=this.svgElement.parentNode.clientWidth,d=this.svgElement.parentNode.clientHeight;c=a.x+20+c<b?a.x:b-c-20;a=a.y+60<d?a.y:d-60;this.tooltip.setAttribute("x",c+22);this.tooltip.setAttribute("y",a+47);this.tooltip_bg.setAttribute("x",c+16);this.tooltip_bg.setAttribute("y",a+28);this.tooltip_subBg.setAttribute("x",c+16);this.tooltip_subBg.setAttribute("y",a+28)};
xiNET.Controller.prototype.setTooltip=function(a,c){if(a){this.tooltip.firstChild.data=a.toString().replace(/&(quot);/g,'"');this.tooltip.setAttribute("display","block");var b=this.tooltip.getComputedTextLength();this.tooltip_bg.setAttribute("width",b+16);this.tooltip_subBg.setAttribute("width",b+16);"undefined"!==typeof c&&null!=c?(this.tooltip_bg.setAttribute("fill",c),this.tooltip_bg.setAttribute("stroke",c),this.tooltip_bg.setAttribute("fill-opacity","0.5")):(this.tooltip_bg.setAttribute("fill",
"white"),this.tooltip_bg.setAttribute("stroke","grey"));this.tooltip_bg.setAttribute("height",28);this.tooltip_subBg.setAttribute("height",28);this.tooltip_bg.setAttribute("display","block");this.tooltip_subBg.setAttribute("display","block")}else this.hideTooltip()};xiNET.Controller.prototype.hideTooltip=function(a){this.tooltip.setAttribute("display","none");this.tooltip_bg.setAttribute("display","none");this.tooltip_subBg.setAttribute("display","none")};function Match(a,c,b,d,e,f,g,h,k,m,l,n,s,u,w,t){function z(a){a=a.toString().trim();if("-"!==a&&"n/a"!==a){A.lastIndex=0;a=a.replace(A,"");C.lastIndex=0;a=a.split(C);for(var b=a.length,c=0;c<b;c++)a[c]=a[c].trim()}else a=null;return a}function x(a){if(a)if(a=a.toString().trim(),""!==a&&"-"!==a&&"n/a"!==a){A.lastIndex=0;a=a.toString().replace(A,"");C.lastIndex=0;a=a.split(C);for(var b=a.length,c=0;c<b;c++){var d=parseInt(a[c]);isNaN(d)?console.debug("Absurd non-numerical position. Match id:"+this.id+
". So-called 'position':"+a[c]):a[c]=d}}else a=null;else a=null;return a}this.controller=a;this.id=c.toString().trim();this.residueLinks=[];this.group=n;this.controller.groups.add(this.group);this.runName=w;this.scanNumber=t;"undefined"!=typeof l&&l&&(l=parseFloat(l),isNaN(l)||(this.score=l,null==this.controller.scores&&(this.controller.scores={min:this.score,max:this.score}),this.score>this.controller.scores.max?this.controller.scores.max=this.score:this.score<this.controller.scores.min&&(this.controller.scores.min=
this.score)));"undefined"!=typeof s&&s&&(s=s.trim(),""!==s&&(this.autovalidated="t"==s||"true"==s||!0===s?!0:!1,this.controller.autoValidatedFound=!0));"undefined"!=typeof u&&u&&(u=u.trim(),""!==u&&(this.validated=u,this.controller.manualValidatedFound=!0));var A=/(['"])/g,C=/[;,]/g;a=/[^A-Z]/g;b=z(b);g=z(g);this.pepSeq1raw=e;this.pepSeq2raw=k;e?(e=e.trim())?(a.lastindex=0,this.pepSeq1=e.replace(a,"")):this.pepSeq1=null:this.pepSeq1=null;k?(k=k.trim())?(a.lastindex=0,this.pepSeq2=k.replace(a,"")):
this.pepSeq2=null:this.pepSeq2=null;d=x(d);h=x(h);f=x(f);m=x(m);1==d.length&&1==h.length&&(this.controller.unambigLinkFound=!0);this.type=null===g&&null===h&&null===m?0:null===g?1:2;var q,r,p,v;if(b){if(0===this.type)if(null!==d)for(e=0;e<d.length;e++)q=e,q>=b.length&&(q=b.length-1),q=b[q],p=d[e],p+=f[0]-1,this.associateWithLink(q,null,p,null,d[e],this.pepSeq1.length,null,null);else for(e=0;e<f.length;e++)q=e,q>=b.length&&(q=b.length-1),q=b[q],p=f[e],this.associateWithLink(q,null,p,null,null,null,
null,null);else if(1===this.type)if(null!==d)for(e=0;e<d.length;e++)q=e,q>=b.length&&(q=b.length-1),q=b[q],p=d[e],v=h?h[e]:d[e],null!==f&&(p+=f[0]-1),null!==m&&(v+=m[0]-1),this.associateWithLink(q,null,p,v,d[e],this.pepSeq1.length,null,null);else for(e=0;e<f.length;e++)q=e,q>=b.length&&(q=b.length-1),q=b[q],p=f[0],v=m[0],this.associateWithLink(q,null,p,v,null,null,null,null);else if(null!==d){if(null!==d)for(e=0;e<d.length;e++)for(k=0;k<h.length;k++)q=e,r=k,q>=b.length&&(q=b.length-1),r>=g.length&&
(r=g.length-1),q=b[q],r=g[r],p=d[e]-0,v=h[k]-0,null!==f&&(p+=f-1),null!==m&&(v+=m-1),this.associateWithLink(q,r,p,v,d[e]-0,this.pepSeq1.length,h[k],this.pepSeq2.length)}else for(e=0;e<f.length;e++)for(k=0;k<m.length;k++)q=e,r=k,q>=b.length&&(q=b.length-1),r>=g.length&&(r=g.length-1),q=b[q],r=g[r],p=f[e]-0,v=m[k]-0,this.associateWithLink(q,r,p,v,null,null,null,null);this.hd=!1;this.overlap=[];q===r&&(this.pepSeq1&&this.pepSeq2?(q=d[0],r=h[0],v=q+(this.pepSeq1.length-1),p=r+(this.pepSeq2.length-1),
q>=r&&q<=p?(this.hd=!0,this.overlap[0]=q-1,this.overlap[1]=v<p?v:p):r>=q&&r<=v&&(this.hd=!0,this.overlap[0]=r-1,this.overlap[1]=p<v?p:v)):p===v&&(this.hd=!0,this.overlap[0]=p-1,this.overlap[1]=v));this.controller.matches.push(this);this.protein1=b;this.pepPos1=d;this.linkPos1=f;this.protein2=g;this.pepPos2=h;this.linkPos2=m}}
Match.prototype.associateWithLink=function(a,c,b,d,e,f,g,h){var k,m,l;null===c?(m=this.controller.proteins.get(a),null===d?(k=""+a+"-null",l=null):(k=""+a+"-"+a,l=m)):a<=c?(k=""+a+"-"+c,m=this.controller.proteins.get(a),l=null!==c?this.controller.proteins.get(c):null):(k=""+c+"-"+a,m=this.controller.proteins.get(c),l=this.controller.proteins.get(a));var n=this.controller.proteinLinks.get(k);void 0===n&&(void 0!==m&&void 0!==l||alert("Something has gone wrong; a link has been added before a protein it links to. "+
a+"-"+c),n=new ProteinLink(k,m,l,this.controller),this.controller.proteinLinks.set(k,n),m.addLink(n),null!==l&&l.addLink(n));k=!1;a===c||null===c?b-0<d-0||null===d?l=b+"-"+d:(l=d+"-"+b,k=!0):a<c?l=b+"-"+d:(l=d+"-"+b,k=!0);m=n.residueLinks.get(l);void 0===m&&(m=a===c?b-0<d-0||"n/a"===d?new ResidueLink(l,n,b,d,this.controller):new ResidueLink(l,n,d,b,this.controller):a==n.fromProtein.id?new ResidueLink(l,n,b,d,this.controller):new ResidueLink(l,n,d,b,this.controller),n.residueLinks.set(l,m),1<this.controller.proteins.size()&&
(a=n.residueLinks.size(),a>ProteinLink.maxNoResidueLinks&&(ProteinLink.maxNoResidueLinks=a)));if("undefined"===typeof m.matches||null==m.matches)m.matches=[];!1===k?m.matches.push([this,e,f,g,h]):m.matches.push([this,g,h,e,f]);this.residueLinks.push(m)};
Match.prototype.meetsFilterCriteria=function(){return this.isAmbig()&&!1===this.controller.ambigShown?!1:"function"==typeof this.controller.filter?this.controller.filter(this):"undefined"!==typeof this.controller.cutOff&&"undefined"!==typeof this.score?this.score>=this.controller.cutOff?!0:!1:!0};Match.prototype.isAmbig=function(){return 1<this.residueLinks.length?!0:!1};xiNET.Link=function(){};xiNET.Link.prototype.mouseDown=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;this.controller.clearSelection();this.setSelected(!0);a=this.controller.getEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};
xiNET.Link.prototype.mouseOver=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!0,!0);this.controller.setTooltip(this.tooltip);return!1};xiNET.Link.prototype.mouseOut=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!1,!0);this.controller.hideTooltip();return!1};
xiNET.Link.prototype.touchStart=function(a){this.controller.preventDefaultsAndStopPropagation(a);void 0!==this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;this.controller.clearSelection();this.setSelected(!0);a=this.controller.getTouchEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};Protein.STICKHEIGHT=20;Protein.MAXSIZE=100;Protein.UNITS_PER_RESIDUE=1;Protein.LABELMAXLENGTH=60;Protein.labelY=-5;Protein.domainColours=d3.scale.ordinal().range(colorbrewer.Paired[5]);Protein.transitionTime=650;
function Protein(a,c,b,d){this.id=a;this.controller=c;this.accession=b;this.name=d;this.name||(this.name=b);this.tooltip=this.name+" ["+this.accession+"]";this.proteinLinks=d3.map();this.selfLink=null;this.y=this.x=40;this.previousRotation=this.rotation=0;this.stickZoom=1;this.form=0;this.isSelected=this.isFlipped=this.isParked=!1;this.customAnnotations=null;this.lowerRotator=new Rotator(this,0,this.controller);this.upperRotator=new Rotator(this,1,this.controller);this.lowerGroup=document.createElementNS(xiNET.svgns,
"g");this.lowerGroup.setAttribute("class","protein lowerGroup");this.highlight=document.createElementNS(xiNET.svgns,"rect");void 0!==xiNET.highlightColour&&this.highlight.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlight.setAttribute("stroke-width","5");this.highlight.setAttribute("fill","none");this.lowerGroup.appendChild(this.highlight);this.rectDomains=document.createElementNS(xiNET.svgns,"g");this.rectDomains.setAttribute("opacity","0");this.lowerGroup.appendChild(this.rectDomains);
this.peptides=document.createElementNS(xiNET.svgns,"g");this.lowerGroup.appendChild(this.peptides);this.upperGroup=document.createElementNS(xiNET.svgns,"g");this.upperGroup.setAttribute("class","protein upperGroup");this.selfLinksHighlights=document.createElementNS(xiNET.svgns,"g");this.selfLinks=document.createElementNS(xiNET.svgns,"g");this.upperGroup.appendChild(this.selfLinksHighlights);this.upperGroup.appendChild(this.selfLinks);this.labelSVG=document.createElementNS(xiNET.svgns,"text");this.labelSVG.setAttribute("text-anchor",
"end");this.labelSVG.setAttribute("fill",this.isDecoy()?"#FB8072":"black");this.labelSVG.setAttribute("x",0);this.labelSVG.setAttribute("y",10);this.labelSVG.setAttribute("class","protein xlv_text proteinLabel");this.labelSVG.setAttribute("font-family","Arial");this.labelSVG.setAttribute("font-size","16");this.labelText=this.name?this.name:null!=this.accession&""!==this.accession?this.accession:this.id;25<this.labelText.length&&(this.labelText=this.labelText.substr(0,16)+"...");this.labelTextNode=
document.createTextNode(this.labelText);this.labelSVG.appendChild(this.labelTextNode);d3.select(this.labelSVG).attr("transform","translate( -5 "+Protein.labelY+") rotate(0) scale(1, 1)");this.upperGroup.appendChild(this.labelSVG);this.ticks=document.createElementNS(xiNET.svgns,"g");this.outline=document.createElementNS(xiNET.svgns,"rect");this.outline.setAttribute("stroke","black");this.outline.setAttribute("stroke-width","1");this.outline.setAttribute("fill","#EEEEEE");this.upperGroup.appendChild(this.outline);
this.upperGroup.appendChild(this.ticks);this.circDomains=document.createElementNS(xiNET.svgns,"g");this.circDomains.setAttribute("opacity",1);this.upperGroup.appendChild(this.circDomains);this.scaleLabels=[];var e=this;this.upperGroup.onmousedown=function(a){e.mouseDown(a)};this.upperGroup.onmouseover=function(a){e.mouseOver(a)};this.upperGroup.onmouseout=function(a){e.mouseOut(a)};this.upperGroup.ontouchstart=function(a){e.touchStart(a)};this.busy=this.isSelected=!1;this.showHighlight(!1)}
Protein.prototype.setSequence=function(a){/\d/.test(a)&&(this.labeling="",-1!==a.indexOf("K4")&&(this.labeling+="K4"),-1!==a.indexOf("K6")&&(this.labeling+="K6"),-1!==a.indexOf("K8")&&(this.labeling+="K8"),-1!==a.indexOf("K10")&&(this.labeling+="R4"),-1!==a.indexOf("R6")&&(this.labeling+="R6"),-1!==a.indexOf("R8")&&(this.labeling+="R8"),-1!==a.indexOf("R10")&&(this.labeling+="R10"));"undefined"!==typeof this.labeling&&(this.labelSVG.innerHTML="["+this.labeling+"] "+this.labelSVG.innerHTML);this.sequence=
a.replace(/[^A-Z]/g,"");this.size=this.sequence.length};Protein.prototype.init=function(){this.setForm(this.form);this.selfLink&&this.selfLink.initSelfLinkSVG();this.setAllLineCoordinates()};Protein.prototype.mouseDown=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;a=this.controller.getEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};
Protein.prototype.touchStart=function(a){this.controller.preventDefaultsAndStopPropagation(a);void 0!==this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;a=this.controller.getTouchEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};Protein.prototype.mouseOver=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!0);this.controller.setTooltip(this.tooltip);return!1};
Protein.prototype.mouseOut=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!1);this.controller.hideTooltip();return!1};Protein.prototype.getBlobRadius=function(){return Math.sqrt(this.size/Math.PI)};Protein.prototype.isDecoy=function(){return this.name?-1===this.name.indexOf("DECOY_")&&"REV"!==this.name?!1:!0:!1};
Protein.prototype.toJSON=function(){return{id:this.id,x:this.x,y:this.y,rot:this.rotation,form:this.form,stickZoom:this.stickZoom,parked:this.isParked,flipped:this.isFlipped}};Protein.prototype.addLink=function(a){this.proteinLinks.has(a.id)||this.proteinLinks.set(a.id,a);!0===a.selfLink()&&(this.selfLink=a,this.size&&this.selfLink.initSelfLinkSVG());null===a.toProtein&&(this.linkerModifications=a)};
Protein.prototype.showHighlight=function(a){!0===a?(this.highlight.setAttribute("stroke",xiNET.highlightColour.toRGB()),this.highlight.setAttribute("stroke-opacity","1")):(0==this.isSelected&&this.highlight.setAttribute("stroke-opacity","0"),this.highlight.setAttribute("stroke",xiNET.selectedColour.toRGB()))};
Protein.prototype.setRotation=function(a){this.rotation=a%360;0>this.rotation&&(this.rotation+=360);this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")");this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")");var c=this.controller.svgElement;a=this.labelSVG.getAttribute("transform");var b=d3.transform(a);a=this.scaleLabels.length;if(90<=this.rotation&&
270>this.rotation){if(b=c.createSVGMatrix().translate(Math.abs(b.translate[0]),-Protein.labelY).rotate(180,0,0),this.labelSVG.transform.baseVal.initialize(c.createSVGTransformFromMatrix(b)),1===this.form){for(c=0;c<a;c++)this.scaleLabels[c].setAttribute("transform","scale(-1,1)");this.ticks.setAttribute("transform","scale(1,-1)")}}else if(b=c.createSVGMatrix().translate(-Math.abs(b.translate[0]),Protein.labelY),this.labelSVG.transform.baseVal.initialize(c.createSVGTransformFromMatrix(b)),1===this.form){for(c=
0;c<a;c++)this.scaleLabels[c].setAttribute("transform","scale(1,1)");this.ticks.setAttribute("transform","scale(1,1)")}};
Protein.prototype.setPosition=function(a,c){this.x=a;this.y=c;1===this.form&&!1===this.isParked?(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")"),this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")")):(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") "),this.lowerGroup.setAttribute("transform",
"translate("+this.x+" "+this.y+") scale("+this.controller.z+") "),null!=this.selfLink&&("undefined"!==typeof this.selfLink.fatLine&&this.selfLink.fatLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")"),this.selfLink.line.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")"),this.selfLink.highlightLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")")))};Protein.rotOffset=17.5;
Protein.minXDist=30;Protein.prototype.switchStickScale=function(a){this.isParked&&this.toggleParked();if(0===this.form)this.toStick();else if(8<Protein.UNITS_PER_RESIDUE*this.stickZoom)this.stickZoom=.5,this.setPosition(a.x,a.y);else{this.stickZoom*=3;var c=this.x-a.x;a=this.y-a.y;if(0===this.rotation||180===this.rotation)a=0;this.setPosition(this.x+2*c,this.y+2*a)}this.scale();this.setAllLineCoordinates()};
Protein.prototype.scale=function(){var a=this.size*Protein.UNITS_PER_RESIDUE*this.stickZoom;if(1===this.form){var c=d3.transform(this.labelSVG.getAttribute("transform")),c=this.controller.svgElement.createSVGMatrix().rotate(c.rotate).translate(-(this.size/2*Protein.UNITS_PER_RESIDUE*this.stickZoom+10),Protein.labelY);this.labelSVG.transform.baseVal.initialize(this.controller.svgElement.createSVGTransformFromMatrix(c));if(this.annotations)for(var c=this.annotations.length,b=0;b<c;b++){var d=this.annotations[b];
d.pieSlice.setAttribute("d",this.getAnnotationRectPath(d));d.colouredRect.setAttribute("d",this.getAnnotationRectPath(d))}d3.select(this.peptides).attr("transform","scale("+this.stickZoom+", 1)");d3.select(this.outline).attr("width",a).attr("x",this.getResXwithStickZoom(.5));d3.select(this.highlight).attr("width",a+5).attr("x",this.getResXwithStickZoom(.5)-2.5);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-Protein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform",
"translate("+(this.getResXwithStickZoom(this.size-0+.5)+Protein.rotOffset)+" 0)");if(null!=this.selfLink)for(c=this.selfLink.residueLinks.values(),b=c.length,d=0;d<b;d++){var e=c[d];e.shown&&(a=this.getResidueLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",a))}if(null!=this.linkerModifications)for(c=this.linkerModifications.residueLinks.values(),b=c.length,d=0;d<b;d++)e=c[d],e.shown&&(a=this.getResidueLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",
a));this.setScaleGroup();this.setRotation(this.rotation)}};
Protein.prototype.setScaleGroup=function(){function a(a,b,c){var d=document.createElementNS(xiNET.svgns,"g");d.setAttribute("transform","translate("+c+" 0)");c=document.createElementNS(xiNET.svgns,"text");c.setAttribute("class","protein xlv_text proteinLabel");c.setAttribute("font-family","'Courier New', monospace");c.setAttribute("font-size","14");c.setAttribute("text-anchor","middle");c.setAttribute("x",0);c.setAttribute("y",Protein.STICKHEIGHT+4);c.appendChild(document.createTextNode(b));d.appendChild(c);
a.scaleLabels.push(c);a.ticks.appendChild(d)}function c(a,b){var c=document.createElementNS(xiNET.svgns,"line");c.setAttribute("x1",b);c.setAttribute("y1",5);c.setAttribute("x2",b);c.setAttribute("y2",10);c.setAttribute("stroke","black");a.ticks.appendChild(c)}d3.select(this.ticks).selectAll("*").remove();this.scaleLabels=[];for(var b=Protein.UNITS_PER_RESIDUE*this.stickZoom,d=-1,e=this.getResXwithStickZoom(this.size),f=1;f<=this.size;f++){if(1===f||0===f%100&&200*b>Protein.minXDist||0===f%10&&20*
b>Protein.minXDist){var g=this.getResXwithStickZoom(f);(8<=b||1!==f)&&c(this,g);d=(d+1)%2;0===d&&g+Protein.minXDist<e&&a(this,f,g)}if(8<=b&&this.sequence){g=document.createElementNS(xiNET.svgns,"g");g.setAttribute("transform","translate("+this.getResXwithStickZoom(f)+" 0)");var h=document.createElementNS(xiNET.svgns,"text");h.setAttribute("font-family","'Courier New', monospace");h.setAttribute("font-size","10px");h.setAttribute("text-anchor","middle");h.setAttribute("x",0);h.setAttribute("y",3);
h.appendChild(document.createTextNode(this.sequence[f-1]));g.appendChild(h);this.scaleLabels.push(h);this.ticks.appendChild(g)}}a(this,this.size,e);8<b&&c(this,e)};Protein.prototype.toggleFlipped=function(){(this.isFlipped=!this.isFlipped)?(this.selfLinks.setAttribute("transform","scale (1 -1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 -1)")):(this.selfLinks.setAttribute("transform","scale (1 1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 1)"))};
Protein.prototype.setParked=function(a,c){this.isParked=a;if(!0!==this.busy)if(0==a)0===this.form?(d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").duration(Protein.transitionTime),this.checkLinks(),d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(Protein.transitionTime)):this.toStick(),this.scale(),this.setAllLineCoordinates();else if(1==a){this.isParked=!0;for(var b=this.proteinLinks.values().length,
d=0;d<b;d++){var e=this.proteinLinks.values()[d];e.hide();for(var e=e.residueLinks.values(),f=e.length,g=0;g<f;g++)e[g].hide()}1===this.form?(this.toCircle(c),b=this.getBlobRadius(),d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill-opacity",1).attr("fill","#EEEEEE").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(Protein.transitionTime),d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime)):
(d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill","#EEEEEE").duration(Protein.transitionTime),d3.select(this.circDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime))}};
Protein.prototype.setForm=function(a,c){if(!0!==this.busy)if(this.isParked)this.setParked(!1);else if(1==a)this.toStick();else{this.toCircle(c);var b=this.getBlobRadius();d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(Protein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime);
d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(Protein.transitionTime)}};
Protein.prototype.toCircle=function(a){function c(a){var b=d3.transform(m.labelSVG.getAttribute("transform")),b=m.controller.svgElement.createSVGMatrix().rotate(b.rotate).translate(g(t(a)),Protein.labelY);m.labelSVG.transform.baseVal.initialize(m.controller.svgElement.createSVGTransformFromMatrix(b));null!==h&&m.setPosition(h(t(a)),k(t(a)));b=e(t(a));m.stickZoom=d(t(a));1==m.form&&m.setRotation(b);m.setAllLineCoordinates();if(1===a){a=m.proteinLinks.values();for(var b=a.length,f=0;f<b;f++){var l=
a[f];if(null===l.toProtein||l.getFromProtein()===m&&0===l.getToProtein().form||l.getToProtein()===m&&0===l.getFromProtein().form||l.getToProtein()==l.getFromProtein())for(var l=l.residueLinks.values(),n=l.length,r=0;r<n;r++)l[r].hide()}m.form=0;m.checkLinks();m.stickZoom=u;m.rotation=w;m.busy=!1;return!0}return 1<a?c(1):!1}this.busy=!0;this.removePeptides();this.upperGroup.contains(this.lowerRotator.svg)&&this.upperGroup.removeChild(this.lowerRotator.svg);this.upperGroup.contains(this.upperRotator.svg)&&
this.upperGroup.removeChild(this.upperRotator.svg);var b=this.getBlobRadius(),d=d3.interpolate(this.stickZoom,0),e=d3.interpolate(180<this.rotation?this.rotation-360:this.rotation,0),f=d3.transform(this.labelSVG.getAttribute("transform")).translate[0],g=d3.interpolate(f,-(b+5)),h=null,k=null;"undefined"!==typeof a&&null!==a&&(h=d3.interpolate(this.x,a.x),k=d3.interpolate(this.y,a.y));var m=this;d3.select(this.ticks).transition().attr("opacity",0).duration(Protein.transitionTime/4).each("end",function(){d3.select(this).selectAll("*").remove()});
d3.select(this.highlight).transition().attr("width",2*b+5).attr("height",2*b+5).attr("x",-b-2.5).attr("y",-b-2.5).attr("rx",b+2.5).attr("ry",b+2.5).duration(Protein.transitionTime);if(null!=this.selfLink)for(var b=this.selfLink.residueLinks.values(),f=b.length,l=0;l<f;l++){var n=b[l];n.shown&&(a=d3.select(n.line),a.attr("d",this.getResidueLinkPath(n)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(Protein.transitionTime),a=d3.select(n.highlightLine),a.attr("d",this.getResidueLinkPath(n)),
a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(Protein.transitionTime))}if(null!=this.linkerModifications)for(b=this.linkerModifications.residueLinks.values(),f=b.length,l=0;l<f;l++)a=b[l],a.shown&&(a=d3.select(a.line),a.attr("fill","none"),a.attr("d","M 0,0 L 0,0"));m=this;if(this.annotations){a=this.annotations;for(var s=a.length,b=0;b<s;b++)f=a[b],l=f.colouredRect,d3.select(f.pieSlice).transition().attr("d",this.getAnnotationPieSliceApproximatePath(f)).duration(Protein.transitionTime).each("end",
function(){for(var a=0;a<s;a++){var b=m.annotations[a];this===b.pieSlice&&d3.select(this).attr("d",m.getAnnotationPieSliceArcPath(b))}}),d3.select(l).transition().attr("d",m.getAnnotationPieSliceApproximatePath(f)).duration(Protein.transitionTime)}var u=this.stickZoom,w=this.rotation,t=d3.ease("cubic-in-out");d3.timer(function(a){return c(a/Protein.transitionTime)})};Protein.prototype.getX=function(){return this.x};Protein.prototype.getY=function(){return this.y};
Protein.prototype.toStick=function(){function a(b){var c=d3.transform(n.labelSVG.getAttribute("transform")),c=n.controller.svgElement.createSVGMatrix().rotate(c.rotate).translate(h(s(b)),Protein.labelY);n.labelSVG.transform.baseVal.initialize(n.controller.svgElement.createSVGTransformFromMatrix(c));c=g(s(b));n.setRotation(c);c=e(s(b));d3.select(n.outline).attr("width",c).attr("x",-(c/2)+.5*Protein.UNITS_PER_RESIDUE*n.stickZoom);n.stickZoom=f(s(b));n.setAllLineCoordinates();return 1===b?(n.busy=!1,
!0):1<b?a(1):!1}this.busy=!0;this.form=1;this.upperGroup.appendChild(this.lowerRotator.svg);this.upperGroup.appendChild(this.upperRotator.svg);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-Protein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.size-0+.5)+Protein.rotOffset)+" 0)");for(var c=this.proteinLinks.values().length,b=0;b<c;b++){var d=this.proteinLinks.values()[b];d.shown&&d.hide()}var c=
this.size*Protein.UNITS_PER_RESIDUE*this.stickZoom,b=this.getBlobRadius(),e=d3.interpolate(2*b,c),f=d3.interpolate(0,this.stickZoom),g=d3.interpolate(0,180<this.rotation?this.rotation-360:this.rotation),h=d3.interpolate(-(b+5),-(this.size/2*Protein.UNITS_PER_RESIDUE*this.stickZoom+10)),b=this.stickZoom;this.stickZoom=0;this.checkLinks();this.stickZoom=b;d3.select(this.circDomains).transition().attr("opacity",0).duration(Protein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",
1).duration(Protein.transitionTime);d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",0).attr("fill","#FFFFFF").attr("height",Protein.STICKHEIGHT).attr("y",-Protein.STICKHEIGHT/2).attr("rx",0).attr("ry",0).duration(Protein.transitionTime);d3.select(this.highlight).transition().attr("width",c+5).attr("height",Protein.STICKHEIGHT+5).attr("x",this.getResXwithStickZoom(.5)-2.5).attr("y",-Protein.STICKHEIGHT/2-2.5).attr("rx",0).attr("ry",0).duration(Protein.transitionTime);
if(null!=this.selfLink)for(c=this.selfLink.residueLinks.values(),b=c.length,d=0;d<b;d++){var k=c[d];k.shown&&(d3.select(k.line).attr("d",this.getAggregateSelfLinkPath()),d3.select(k.line).transition().attr("d",this.getResidueLinkPath(k)).duration(Protein.transitionTime),d3.select(k.highlightLine).attr("d",this.getAggregateSelfLinkPath()),d3.select(k.highlightLine).transition().attr("d",this.getResidueLinkPath(k)).duration(Protein.transitionTime))}if(null!=this.linkerModifications)for(c=this.linkerModifications.residueLinks.values(),
b=c.length,d=0;d<b;d++)if(k=c[d],k.shown){var m=this.getResidueLinkPath(k);d3.select(k.line).attr("d","M 0,0 L 0,0 L 0,0 L 0,0");d3.select(k.line).transition().attr("d",m).duration(Protein.transitionTime);d3.select(k.highlightLine).attr("d","M 0,0 L 0,0");d3.select(k.highlightLine).transition().attr("d",m).duration(Protein.transitionTime)}if(this.annotations)for(c=this.annotations,b=c.length,d=0;d<b;d++){var k=c[d],m=k.pieSlice,l=k.colouredRect;m.setAttribute("d",this.getAnnotationPieSliceApproximatePath(k));
d3.select(m).transition().attr("d",this.getAnnotationRectPath(k)).duration(Protein.transitionTime);d3.select(l).transition().attr("d",this.getAnnotationRectPath(k)).duration(Protein.transitionTime)}var n=this,s=d3.ease("cubic-in-out");d3.timer(function(b){return a(b/Protein.transitionTime)});d3.select(this.ticks).attr("opacity",0);this.setScaleGroup();d3.select(this.ticks).transition().attr("opacity",1).delay(.8*Protein.transitionTime).duration(Protein.transitionTime/2)};
Protein.prototype.getAggregateSelfLinkPath=function(){var a=this.getBlobRadius()+7,c=Protein.trig(a,70),b=Protein.trig(a,20),d=Protein.trig(a,85),e=Protein.trig(a,5);return"M 0,0 Q "+d.x+","+-d.y+" "+c.x+","+-c.y+" A "+a+" "+a+" 0 0 1 "+b.x+","+-b.y+" Q "+e.x+","+-e.y+" 0,0"};
Protein.prototype.getResidueLinkPath=function(a){var c=this.getResXwithStickZoom(a.fromResidue),b=0;8<=Protein.UNITS_PER_RESIDUE*this.stickZoom&&(b=-5);if(isNaN(parseFloat(a.toResidue))){!1===a.ambig&&a.line.setAttribute("fill",xiNET.defaultSelfLinkColour.toRGB());var d=[c,26],e=[c,18],f=Protein.rotatePointAboutPoint(d,e,60);return"M "+c+","+-1*b+" L "+d[0]+","+d[1]+" L "+f[0]+","+f[1]+" L "+e[0]+","+e[1]}var d=this.getResXwithStickZoom(a.toResidue),g,h,f=Math.abs(d-c)/2,e=-(Protein.STICKHEIGHT/2+
3);15>f&&(e=-28+f);var k=[c,b],m=[d,b];!0===a.intraMolecular?(g=c+(d-c)/2,b=[g,e-f],h=[g,e-f],a=[g,e-f],g=[g,e-f]):a.hd?(g=c+(d-c)/2,b=[g,e-f],h=[g,e-f],a=Protein.rotatePointAboutPoint([c,e-f],k,-20),g=Protein.rotatePointAboutPoint([d,e-f],m,20)):(a=[c,e],g=[d,b],b=[c,e],h=[d,e]);return" M "+k[0]+","+k[1]+" Q "+a[0]+","+a[1]+" "+b[0]+","+b[1]+" A "+f+","+f+"  0 0 1 "+h[0]+","+h[1]+" Q "+g[0]+","+g[1]+" "+m[0]+","+m[1]};
Protein.prototype.showPeptides=function(a){if(1===this.form)for(var c=-Protein.STICKHEIGHT/2,b=a.length,d=Protein.STICKHEIGHT/b,e=0;e<b;e++){var f=a[e],g=document.createElementNS(xiNET.svgns,"rect");g.setAttribute("class","protein");var h=f[1];if(0<h){var k=(f[0]+.5-this.size/2)*Protein.UNITS_PER_RESIDUE,h=h*Protein.UNITS_PER_RESIDUE;g.setAttribute("x",k);g.setAttribute("y",c);g.setAttribute("width",h);g.setAttribute("height",d);g.setAttribute("fill",xiNET.highlightColour.toRGB());this.peptides.appendChild(g)}f[2]&&
(g=document.createElementNS(xiNET.svgns,"rect"),g.setAttribute("class","protein"),k=(f[2]+.5-this.size/2)*Protein.UNITS_PER_RESIDUE,h=(f[3]-f[2])*Protein.UNITS_PER_RESIDUE,g.setAttribute("x",k),g.setAttribute("y",c),g.setAttribute("width",h),g.setAttribute("height",d),g.setAttribute("fill",xiNET.homodimerLinkColour.toRGB()),g.setAttribute("fill-opacity","0.5"),this.peptides.appendChild(g));c+=d}};Protein.prototype.removePeptides=function(){d3.select(this.peptides).selectAll("*").remove()};
Protein.prototype.getResXwithStickZoom=function(a){return(a-this.size/2)*Protein.UNITS_PER_RESIDUE*this.stickZoom};Protein.rotatePointAboutPoint=function(a,c,b){b=b/360*Math.PI*2;var d=Math.cos(b)*(a[0]-c[0])-Math.sin(b)*(a[1]-c[1])+c[0];a=Math.sin(b)*(a[0]-c[0])+Math.cos(b)*(a[1]-c[1])+c[1];return[d,a]};Protein.prototype.checkLinks=function(){for(var a=this.proteinLinks.values(),c=a.length,b=0;b<c;b++)a[b].check()};
Protein.prototype.setAllLineCoordinates=function(){for(var a=this.proteinLinks.values(),c=a.length,b=0;b<c;b++){var d=a[b];if(null!==d.getToProtein()&&0===d.getFromProtein().form&&0===d.getToProtein().form)d.setLineCoordinates(this);else for(var d=d.residueLinks.values(),e=d.length,f=0;f<e;f++){var g=d[f];g.setLineCoordinates(this);var h=g.proteinLink.getOtherEnd(this);h&&1===h.form&&8<h.stickZoom*Protein.UNITS_PER_RESIDUE&&g.setLineCoordinates(h)}}};
Protein.prototype.countExternalLinks=function(){if(this.isParked)return 0;for(var a=0,c=this.proteinLinks.keys().length,b=0;b<c;b++){var d=this.proteinLinks.values()[b];d.selfLink()||!0===d.check()&&a++}return a};Protein.prototype.getSubgraph=function(a){null==this.subgraph&&(a={nodes:d3.map(),links:d3.map()},a.nodes.set(this.id,this),!1===this.isParked&&(this.subgraph=this.addConnectedNodes(a)),this.controller.subgraphs.push(a));return this.subgraph};
Protein.prototype.addConnectedNodes=function(a){for(var c=this.proteinLinks.values(),b=c.length,d=0;d<b;d++){var e=c[d];e.fromProtein===e.toProtein||!0!==e.check()||a.links.has(e.id)||(a.links.set(e.id,e),e=e.getFromProtein()===this?e.getToProtein():e.getFromProtein(),null===e||a.nodes.has(e.id)||(a.nodes.set(e.id,e),e.subgraph=a,e.addConnectedNodes(a)))}return a};
Protein.prototype.clearPositionalFeatures=function(a){this.annotations=[];this.circDomains&&d3.select(this.circDomains).selectAll("*").remove();this.rectDomains&&d3.select(this.rectDomains).selectAll("*").remove()};
Protein.prototype.setPositionalFeatures=function(a){this.clearPositionalFeatures();if(a){a.sort(function(a,b){return b.end-b.start-(a.end-a.start)});this.annotations=a;for(var c=0;c<a.length;c++){var b=a[c];b.start-=0;b.end-=0;b.pieSlice=document.createElementNS(xiNET.svgns,"path");b.colouredRect=document.createElementNS(xiNET.svgns,"path");0===this.form?(b.pieSlice.setAttribute("d",this.getAnnotationPieSliceArcPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationPieSliceApproximatePath(b))):
(b.pieSlice.setAttribute("d",this.getAnnotationRectPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationRectPath(b)));b.pieSlice.setAttribute("stroke-width",1);b.pieSlice.setAttribute("fill-opacity","0.5");b.colouredRect.setAttribute("stroke-width",1);b.colouredRect.setAttribute("fill-opacity","0.5");b.pieSlice.name=b.name+" ["+b.start+" - "+b.end+"]";var d=this.controller,e=this;b.pieSlice.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;
d.preventDefaultsAndStopPropagation(a);d.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};b.colouredRect.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;d.preventDefaultsAndStopPropagation(a);d.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};this.circDomains.appendChild(b.pieSlice);this.rectDomains.appendChild(b.colouredRect)}}};Protein.trig=function(a,c){var b=c/360*Math.PI*2;return{x:a*Math.cos(b),y:a*Math.sin(b)}};
Protein.stepsInArc=5;Protein.prototype.getAnnotationPieSliceArcPath=function(a){var c=(a.start-1)/this.size*360;a=a.end/this.size*360;var b=this.getBlobRadius()-2,d=Protein.trig(b,c-90),e=Protein.trig(b,a-90),f=0;if(180<a-c||a==c)f=1;return"M0,0 L"+d.x+","+d.y+" A"+b+","+b+" 0 "+f+" 1 "+e.x+","+e.y+" Z"};
Protein.prototype.getAnnotationPieSliceApproximatePath=function(a){var c=(a.start-1)/this.size*360;a=a.end/this.size*360;var b=this.getBlobRadius()-2;Protein.trig(b,c-90);Protein.trig(b,a-90);for(var d="M 0,0",e=0;e<=Protein.stepsInArc;e++)var f=Protein.trig(b,c+e/5*(a-c)-90),d=d+(" L "+f.x+","+f.y);return d+=" L 0,0  Z"};
Protein.prototype.getAnnotationRectPath=function(a){var c=Protein.STICKHEIGHT/2,b=-Protein.STICKHEIGHT/2,d=this.getResXwithStickZoom(a.start-.5);a=(1+(a.end-a.start))*Protein.UNITS_PER_RESIDUE*this.stickZoom;for(var e="M "+d+","+c,f=0;f<=Protein.stepsInArc;f++)e+=" L "+(d+f/Protein.stepsInArc*a)+","+b;return e+(" L "+(d+a)+","+c+" Z")};function Annotation(a,c,b,d,e){this.name=a;this.start=c-0;this.end=b-0;void 0!==d&&null!==d&&(this.colour=new RGBColor(d));this.notes=e};ProteinLink.maxNoResidueLinks=0;ProteinLink.prototype=new xiNET.Link;
function ProteinLink(a,c,b,d){this.id=a;this.residueLinks=d3.map();this.controller=d;this.fromProtein=c;this.toProtein=b;this.ambig=!1;this.tooltip=this.id;this.hidden=this.shown=!1;this.selfLink()?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path"),this.fatLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.highlightLine=document.createElementNS(xiNET.svgns,"line"),this.fatLine=
document.createElementNS(xiNET.svgns,"line"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","black");this.line.setAttribute("stroke-width",1);this.line.setAttribute("stroke-linecap","round");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-linecap",
"round");this.highlightLine.setAttribute("stroke-opacity","0");this.fatLine.setAttribute("class","link");this.fatLine.setAttribute("fill","none");this.fatLine.setAttribute("stroke","lightgray");this.fatLine.setAttribute("stroke-linecap","round");this.fatLine.setAttribute("stroke-linejoin","round");var e=this;this.line.onmousedown=function(a){e.mouseDown(a)};this.line.onmouseover=function(a){e.mouseOver(a)};this.line.onmouseout=function(a){e.mouseOut(a)};this.line.ontouchstart=function(a){e.touchStart(a)};
this.highlightLine.onmousedown=function(a){e.mouseDown(a)};this.highlightLine.onmouseover=function(a){e.mouseOver(a)};this.highlightLine.onmouseout=function(a){e.mouseOut(a)};this.highlightLine.ontouchstart=function(a){e.touchStart(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmouseover=function(a){e.mouseOver(a)};this.fatLine.onmouseout=function(a){e.mouseOut(a)};this.fatLine.ontouchstart=function(a){e.touchStart(a)};
this.isSelected=!1}ProteinLink.prototype.selfLink=function(){return this.fromProtein===this.toProtein};ProteinLink.prototype.initSelfLinkSVG=function(){var a=this.fromProtein.getAggregateSelfLinkPath();this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.fatLine.setAttribute("d",a)};ProteinLink.prototype.getFromProtein=function(){return this.fromProtein};ProteinLink.prototype.getToProtein=function(){return this.toProtein};
ProteinLink.prototype.showHighlight=function(a,c){"undefined"===typeof c&&(c=!1);this.shown&&(a?(this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1")):(this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0")));if(c&&this.ambig)for(var b=this.residueLinks.values().length,d=0;d<b;d++)for(var e=this.residueLinks.values()[d],f=e.matches.length,
g=0;g<f;g++){var h=e.matches[g][0];if(h.isAmbig())for(var k=h.residueLinks.length,m=0;m<k;m++)e=h.residueLinks[m],!0===e.shown&&0==e.isSelected&&e.showHighlight(a,!1),!0===e.proteinLink.shown&&e.proteinLink.showHighlight(a,!1)}};
ProteinLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB()),
this.controller.linkSelectionChanged())};ProteinLink.prototype.getFilteredMatches=function(){for(var a=this.residueLinks.values(),c=a.length,b=d3.map(),d=0;d<c;d++)for(var e=a[d],f=e.matches.length,g=0;g<f;g++){var h=e.matches[g];h.meetsFilterCriteria()&&b.set(h.id)}return b.keys()};
ProteinLink.prototype.check=function(){if(this.fromProtein.isParked||null!==this.toProtein&&this.toProtein.isParked)return this.hide(),!1;if(this.selfLink()&&!1===this.controller.selfLinksShown){if(0===this.fromProtein.form)this.hide();else for(var a=this.residueLinks.values(),c=a.length,b=0;b<c;b++)a[b].hide();return!1}if(this.hidden){if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form)this.hide();else for(a=this.residueLinks.values(),c=a.length,b=0;b<c;b++)a[b].hide();return!1}a=
this.residueLinks.values();c=a.length;this.hd=!1;if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form){this.ambig=!0;for(var d=[],e=d3.map(),f=d3.map(),b=0;b<c;b++){var g=a[b],h=!1;if(g.matches)for(var k=g.matches.length,m=0;m<k;m++){var l=g.matches[m][0];if(l.meetsFilterCriteria())if(!0===l.hd&&(this.hd=!0),!1===h&&(h=!0,d.push(g)),e.set(l.id,l),l.isAmbig())for(var n=0;n<l.residueLinks.length;n++)f.set(l.residueLinks[n].proteinLink.id);else this.ambig=!1}else d.push(g)}b=
d.length;if(0<b){this.tooltip=this.id+", "+b+" unique cross-link";1<b&&(this.tooltip+="s");this.tooltip+=" ("+e.keys().length;1===e.keys().length?this.tooltip+=" match)":this.tooltip+=" matches)";this.w=45/ProteinLink.maxNoResidueLinks*b;this.ambig=this.ambig&&1<f.keys().length;this.dashedLine(this.ambig);if(1<this.controller.groups.values().length){a=d3.set();c=e.values();e=c.length;for(b=0;b<e;b++)l=c[b],a.add(l.group);1==a.values().length?(b=this.controller.linkColours(a.values()[0]),this.line.setAttribute("stroke",
b)):this.line.setAttribute("stroke","#000000")}else this.selfLink()&&(this.hd?(this.line.setAttribute("stroke",xiNET.homodimerLinkColour.toRGB()),this.line.setAttribute("stroke-width",xiNET.homodimerLinkWidth)):(this.line.setAttribute("stroke","black"),this.line.setAttribute("stroke-width",1)));this.show();return!0}this.hide();return!1}if(null!==this.toProtein||0!==this.fromProtein.form){b=!1;for(l=0;l<c;l++)!0===a[l].check()&&(b=!0);return b}};
ProteinLink.prototype.dashedLine=function(a){1==this.controller.unambigLinkFound&&(a?!0===this.selfLink()?this.line.setAttribute("stroke-dasharray","4, 4"):this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z):a||this.line.removeAttribute("stroke-dasharray"))};
ProteinLink.prototype.show=function(){this.shown||(this.shown=!0,this.selfLink()?(1<ProteinLink.maxNoResidueLinks&&(this.fatLine.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.controller.p_pLinksWide.appendChild(this.fatLine)),this.line.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.highlightLine.setAttribute("transform","translate("+this.fromProtein.x+" "+
this.fromProtein.y+") scale("+this.controller.z+")")):(this.line.setAttribute("stroke-width",1*this.controller.z),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.fromProtein),this.setLineCoordinates(this.toProtein),1<ProteinLink.maxNoResidueLinks&&this.controller.p_pLinksWide.appendChild(this.fatLine)),this.controller.highlights.appendChild(this.highlightLine),this.controller.p_pLinks.appendChild(this.line));1<ProteinLink.maxNoResidueLinks&&(this.selfLink()?
this.fatLine.setAttribute("stroke-width",this.w):this.fatLine.setAttribute("stroke-width",this.controller.z*this.w))};ProteinLink.prototype.hide=function(){this.shown&&(this.shown=!1,this.selfLink(),1<ProteinLink.maxNoResidueLinks&&this.controller.p_pLinksWide.removeChild(this.fatLine),this.controller.highlights.removeChild(this.highlightLine),this.controller.p_pLinks.removeChild(this.line))};
ProteinLink.prototype.setLineCoordinates=function(a){!1===this.selfLink()&&null!==this.getToProtein()&&this.shown&&(this.getFromProtein()===a?(this.line.setAttribute("x1",a.x),this.line.setAttribute("y1",a.y),this.highlightLine.setAttribute("x1",a.x),this.highlightLine.setAttribute("y1",a.y),this.fatLine.setAttribute("x1",a.x),this.fatLine.setAttribute("y1",a.y)):this.getToProtein()===a&&(this.line.setAttribute("x2",a.x),this.line.setAttribute("y2",a.y),this.highlightLine.setAttribute("x2",a.x),this.highlightLine.setAttribute("y2",
a.y),this.fatLine.setAttribute("x2",a.x),this.fatLine.setAttribute("y2",a.y)))};ProteinLink.prototype.getOtherEnd=function(a){return this.fromProtein===a?this.toProtein:this.fromProtein};ResidueLink.prototype=new xiNET.Link;function ResidueLink(a,c,b,d,e,f){this.id=a;this.controller=e;this.proteinLink=c;this.fromResidue=b;this.toResidue=d;this.ambig=!1;this.tooltip=this.id;!0===f&&(this.flip=!0);this.dashed=this.shown=!1;this.initSVG()}
ResidueLink.prototype.initSVG=function(){if("undefined"===typeof this.line){!0===this.selfLink()||null===this.proteinLink.toProtein?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.line.setAttribute("stroke",xiNET.defaultInterLinkColour.toRGB()),this.line.setAttribute("stroke-linecap","round"),this.highlightLine=document.createElementNS(xiNET.svgns,"line"),this.highlightLine.setAttribute("stroke-linecap",
"round"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-opacity","0");"undefined"!==typeof this.colour&&this.line.setAttribute("stroke",this.colour);var a=this;this.line.onmousedown=function(c){a.mouseDown(c)};
this.line.onmouseover=function(c){a.mouseOver(c)};this.line.onmouseout=function(c){a.mouseOut(c)};this.line.ontouchstart=function(c){a.touchStart(c)};this.highlightLine.onmousedown=function(c){a.mouseDown(c)};this.highlightLine.onmouseover=function(c){a.mouseOver(c)};this.highlightLine.onmouseout=function(c){a.mouseOut(c)};this.highlightLine.ontouchstart=function(c){a.touchStart(c)}}this.isSelected=!1};ResidueLink.prototype.selfLink=function(){return this.proteinLink.fromProtein===this.proteinLink.toProtein};
ResidueLink.prototype.getFromProtein=function(){return this.proteinLink.fromProtein};ResidueLink.prototype.getToProtein=function(){return this.proteinLink.toProtein};
ResidueLink.prototype.showHighlight=function(a,c){if(!(this.proteinLink.fromProtein.busy||this.proteinLink.toProtein&&this.proteinLink.toProtein.busy)){"undefined"===typeof c&&(c=!1);if(this.shown)if(a){this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-opacity","0.7");for(var b=[],d=[],e=this.getFilteredMatches(),f=e.length,g=0;g<f;g++){var h=e[g][0],k=e[g][3]-1,m=e[g][4];b.push([e[g][1]-1,e[g][2],h.overlap[0],h.overlap[1]]);d.push([k,
m,h.overlap[0],h.overlap[1]])}this.proteinLink.fromProtein.showPeptides(b);null!==this.proteinLink.toProtein&&this.proteinLink.toProtein.showPeptides(d);g=d3.map();g.set(this.id,this);this.controller.linkHighlightsChanged(g)}else this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0"),this.proteinLink.fromProtein.removePeptides(),null!==this.proteinLink.toProtein&&this.proteinLink.toProtein.removePeptides(),this.controller.linkHighlightsChanged(d3.map());
if(c&&this.ambig)for(b=this.matches?this.matches.length:0,g=0;g<b;g++)if(h=this.matches[g][0],h.isAmbig())for(d=h.residueLinks.length,e=0;e<d;e++)f=h.residueLinks[e],f.showHighlight(a,!1),f.proteinLink.showHighlight(a,!1)}};
ResidueLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","0.7"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",
xiNET.highlightColour.toRGB()),this.controller.linkSelectionChanged())};ResidueLink.prototype.getFilteredMatches=function(){this.ambig=!0;this.intraMolecular=this.hd=!1;for(var a=[],c=this.matches?this.matches.length:0,b=0;b<c;b++){var d=this.matches[b][0];d.meetsFilterCriteria()&&(a.push(this.matches[b]),!1===d.isAmbig()&&(this.ambig=!1),!0===d.hd&&(this.hd=!0),1===d.type&&(this.intraMolecular=!0))}return a};
ResidueLink.prototype.check=function(a){if(!1===this.controller.selfLinkShown&&this.selfLink()||this.proteinLink.hidden)return this.hide(),!1;if("undefined"===typeof this.matches||null==this.matches)return this.ambig=!1,this.show(),!0;var c=this.getFilteredMatches();a=c.length;if(0<a){this.show();this.dashedLine(this.ambig);if(1<this.controller.groups.values().length){for(var b=d3.set(),d=0;d<a;d++)b.add(c[d][0].group);1==b.values().length?(c=this.controller.linkColours(b.values()[0]),this.line.setAttribute("stroke",
c),this.line.setAttribute("transform","scale (1 1)"),this.highlightLine.setAttribute("transform","scale (1 1)")):(this.line.setAttribute("stroke","#000000"),this.selfLink()&&(this.line.setAttribute("transform","scale (1 -1)"),this.highlightLine.setAttribute("transform","scale (1 -1)")))}else!0===this.selfLink()&&null==this.colour?!0===this.hd?(this.line.setAttribute("stroke",xiNET.homodimerLinkColour.toRGB()),this.line.setAttribute("transform","scale(1, -1)"),this.line.setAttribute("stroke-width",
xiNET.homodimerLinkWidth),this.highlightLine.setAttribute("transform","scale(1, -1)")):(this.line.setAttribute("stroke",xiNET.defaultSelfLinkColour.toRGB()),this.line.setAttribute("transform","scale(1, 1)"),this.line.setAttribute("stroke-width",xiNET.linkWidth),this.highlightLine.setAttribute("transform","scale(1, 1)")):!0===this.selfLink()&&this.line.setAttribute("stroke-width",xiNET.linkWidth);this.tooltip=this.proteinLink.fromProtein.labelText+"_"+this.fromResidue+"-"+(null!=this.proteinLink.toProtein?
this.proteinLink.toProtein.labelText:"null")+"_"+this.toResidue+" ("+a;this.tooltip=1==a?this.tooltip+" match)":this.tooltip+" matches)";return!0}this.hide();return!1};
ResidueLink.prototype.dashedLine=function(a){1!=this.controller.unambigLinkFound||"undefined"===typeof this.line||isNaN(parseFloat(this.toResidue))||(a?!0===this.selfLink()?(this.dashed=!0,this.line.setAttribute("stroke-dasharray","4, 4")):(this.dashed=!0,this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z)):a||(this.dashed=!1,this.line.removeAttribute("stroke-dasharray")))};
ResidueLink.prototype.show=function(){if(this.controller.sequenceInitComplete&&!this.shown)if(this.shown=!0,"undefined"===typeof this.line&&this.initSVG(),this.selfLink()||null===this.proteinLink.toProtein){var a=this.proteinLink.fromProtein.getResidueLinkPath(this);this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.proteinLink.fromProtein.selfLinksHighlights.appendChild(this.highlightLine);this.proteinLink.fromProtein.selfLinks.appendChild(this.line)}else this.line.setAttribute("stroke-width",
this.controller.z*xiNET.linkWidth),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.proteinLink.fromProtein),this.setLineCoordinates(this.proteinLink.toProtein),this.controller.highlights.appendChild(this.highlightLine),this.controller.res_resLinks.appendChild(this.line)};
ResidueLink.prototype.hide=function(){this.controller.sequenceInitComplete&&this.shown&&(this.shown=!1,this.selfLink()||null===this.proteinLink.toProtein?(this.proteinLink.fromProtein.selfLinksHighlights.removeChild(this.highlightLine),this.proteinLink.fromProtein.selfLinks.removeChild(this.line)):(this.controller.res_resLinks.removeChild(this.line),this.controller.highlights.removeChild(this.highlightLine)))};
ResidueLink.prototype.setLineCoordinates=function(a){if(null!=a.x&&null!=a.y&&!1===this.selfLink()&&null!==this.getToProtein()&&this.shown){var c;this.getFromProtein()===a?(0===a.form?(c=a.x,a=a.y):(a=this.getResidueCoordinates(this.fromResidue,a),c=a[0],a=a[1]),this.line.setAttribute("x1",c),this.line.setAttribute("y1",a),this.highlightLine.setAttribute("x1",c),this.highlightLine.setAttribute("y1",a)):this.getToProtein()===a&&(0===a.form?(c=a.x,a=a.y):(a=this.getResidueCoordinates(this.toResidue,
a),c=a[0],a=a[1]),this.line.setAttribute("x2",c),this.line.setAttribute("y2",a),this.highlightLine.setAttribute("x2",c),this.highlightLine.setAttribute("y2",a))}};
ResidueLink.prototype.getResidueCoordinates=function(a,c){var b=c.getResXwithStickZoom(a)*this.controller.z,d=0;if(8<Protein.UNITS_PER_RESIDUE*c.stickZoom){var d=this.getFromProtein(),e=this.getToProtein(),f=Math.atan2(d.y-e.y,d.x-e.x)/(2*Math.PI)*360;0>f&&(f+=360);c===d?(d=f-d.rotation,0>d&&(d+=360),e=5,180>d&&(e=-5)):(d=f-e.rotation,0>d&&(d+=360),e=5,180<d&&(e=-5));d=e*this.controller.z}d=Protein.rotatePointAboutPoint([b,d],[0,0],c.rotation);b=d[0]+c.x;d=d[1]+c.y;return[b,d]};
ResidueLink.prototype.leastAmbiguousMatches=function(){};ResidueLink.prototype.toJSON=function(){for(var a=[],c=this.matches.length,b=0;b<c;b++)a.push(this.matches[b].id);return{}};function xiNET_Storage(a){this.controller=a}xiNET_Storage.ns="xiNET.";xiNET_Storage.accessionFromId=function(a){a+="";return-1!==a.indexOf("|")?a.split("|")[1]:a};
xiNET_Storage.prototype.getUniProtTxt=function(a,c){function b(){d3.text("http://www.uniprot.org/uniprot/"+d+".txt",function(b){"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"UniProtKB."+d,b);c(a,b)})}var d=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var e=localStorage.getItem(xiNET_Storage.ns+"UniProtKB."+d);e?c(a,e):b()}else b()};
xiNET_Storage.prototype.getSequence=function(a,c){function b(){d3.text("http://www.uniprot.org/uniprot/"+d+".fasta",function(b){var e="";b=b.split("\n");for(var h=b.length,k=1;k<h;k++)var m=b[k],m=b[k],e=e+m;e=e.replace(/[^A-Z]/g,"");"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"UniProtKB.fasta."+d,e);c(a,e)})}var d=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var e=localStorage.getItem(xiNET_Storage.ns+"UniProtKB.fasta."+d);e?c(a,e):b()}else b()};
xiNET_Storage.prototype.getUniProtFeatures=function(a,c){this.getUniProtTxt(a,function(a,d){var e=[];if(null!==d)for(var f=d.split("\n"),g=f.length,h=0;h<g;h++){var k=f[h];0===k.indexOf("FT")&&(k=k.split(/\s{2,}/g),4<k.length&&"CHAIN"!==k[1]&&e.push(new Annotation(k[1],k[2],k[3],null,k[4])))}c(a,e)})};
xiNET_Storage.prototype.getSuperFamFeatures=function(a,c){function b(){d3.xml("http://supfam.org/SUPERFAMILY/cgi-bin/das/up/features?segment="+e,function(a){a=(new XMLSerializer).serializeToString(a);"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"SuperFamDAS."+e,a);d(a)})}function d(b){if(window.DOMParser)var d=(new DOMParser).parseFromString(b,"text/xml");else d=new ActiveXObject("Microsoft.XMLDOM"),d.async=!1,d.loadXML(b);b=[];for(var d=d.getElementsByTagName("FEATURE"),e=
d.length,f=0;f<e;f++){var l=d[f],n=l.getElementsByTagName("TYPE")[0];if("miscellaneous"===n.getAttribute("category")){var n=n.getAttribute("id"),s=l.getElementsByTagName("START")[0].textContent,l=l.getElementsByTagName("END")[0].textContent;b.push(new Annotation(n,s,l))}}c(a,b)}var e=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var f=localStorage.getItem(xiNET_Storage.ns+"SuperFamDAS."+e);f?d(f):b()}else b()};function Rotator(a,c,b){var d=this;this.ctrl=b;this.proteinOrPartThereof=a;this.upperOrLower=c;this.svg=document.createElementNS(xiNET.svgns,"g");this.rotatorSymbol=document.createElementNS(xiNET.svgns,"g");a=document.createElementNS(xiNET.svgns,"circle");a.setAttribute("r",14);a.setAttribute("stroke","none");a.setAttribute("fill","gray");a.setAttribute("fill-opacity","0.0");this.svg.appendChild(a);a=document.createElementNS(xiNET.svgns,"circle");a.setAttribute("r",20);a.setAttribute("stroke","black");
a.setAttribute("stroke-width","1");a.setAttribute("fill","none");this.rotatorSymbol.appendChild(a);a=document.createElementNS(xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");this.rotatorSymbol.appendChild(a);a=document.createElementNS(xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");
a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");a.setAttribute("transform","rotate(180)");this.rotatorSymbol.appendChild(a);this.rotatorSymbol.setAttribute("transform","rotate(45) scale (0.7, 0.7)");this.rotatorSymbol.setAttribute("display","none");this.inner=document.createElementNS(xiNET.svgns,"g");this.inner.setAttribute("class","PV_rotator");this.inner.appendChild(this.rotatorSymbol);this.svg.appendChild(this.inner);this.svg.onmouseover=function(a){d.rotatorMouseOver(a)};
this.svg.onmouseout=function(a){d.rotatorMouseOut(a)};this.svg.onmousedown=function(a){d.rotatorMouseDown(a)}}Rotator.prototype.rotatorMouseOver=function(a){this.ctrl.rotating||this.rotatorSymbol.setAttribute("display","block")};Rotator.prototype.rotatorMouseOut=function(a){this.rotatorSymbol.setAttribute("display","none")};
Rotator.prototype.rotatorMouseDown=function(a){this.ctrl.state=xiNET.Controller.ROTATING;this.ctrl.dragElement=this.proteinOrPartThereof;a=this.ctrl.getEventPoint(a);this.ctrl.mouseToSVG(a.x,a.y);this.ctrl.whichRotator=this.upperOrLower;return!1};xiNET.Controller.prototype.readCSV=function(a,c,b){function d(a){for(var b=1;b<q;b++)for(var c=h[b][a].replace(/(['"])/g,"").split(/[;,]/),d=0;d<c.length;d++){var e=c[d].trim();if("-"!==e.trim()&&"n/a"!==e.trim()){var f,k;if(-1===c[d].indexOf("|"))f=c[d].trim();else{k=c[d].split("|");f=k[1].trim();k=k[2].trim();var l=k.indexOf("_");-1!==l&&(k=k.substring(0,l).trim())}g.proteins.has(e)||(f=new Protein(e,g,f,k),g.proteins.set(e,f))}}}function e(a){var b=a;-1!==a.indexOf("|")&&(a=a.split("|"),3===a.length&&
(b=a[2],a=b.indexOf("_"),-1!==a&&(b=b.substring(0,a))));return b}function f(){for(var a,b,c,d,e=1;e<q;e++){a=h[e][m];b=h[e][n];c=-1!==w?h[e][w]:e;-1!==u&&(d=h[e][u]);var f=/(.*)-(.*)-a(\d*)-b(\d*)/.exec(c),k=/(.*)-(.*)-(.*)/.exec(c);if(null!==f){for(var p=f[1],k=f[2],r=f[3]-0,v=f[4]-0,f=h[e][t].toString().split(/[;,]/),y=0;y<f.length;y++)f[y]=parseInt(f[y])-r+1;for(var B=h[e][x].toString().split(/[;,]/),y=0;y<B.length;y++)B[y]=parseInt(B[y])-v+1;g.addMatch(c,a,f.join(";"),p,r,b,B.join(";"),k,v,d)}else if(-1===
C||null===k||"intralink"!==h[e][C]&&"monolink"!==h[e][C])f=h[e],g.addMatch(c,a,f[l],f[z],f[t],b,f[s],f[A],f[x],d);else{p=k[1];r=parseInt(k[2].substring(1));f=h[e][t].toString().split(/[;,]/);for(y=0;y<f.length;y++)f[y]=parseInt(f[y])-r+1;"intralink"===h[e][C]?(v=parseInt(k[3].substring(1)),g.addMatch(c,a,f.join(";"),p,r,null,null,null,v,d)):g.addMatch(c,a,f.join(";"),p,r,null,null,null,null,d)}}}var g=this,h=d3.csv.parseRows(a);a=h[0];for(var k=0;k<a.length;k++)a[k]=a[k].trim();var m=a.indexOf("Protein1"),
l=a.indexOf("PepPos1"),n=a.indexOf("Protein2"),s=a.indexOf("PepPos2"),u=a.indexOf("Score"),w=a.indexOf("Id"),t=a.indexOf("LinkPos1"),z=a.indexOf("PepSeq1"),x=a.indexOf("LinkPos2"),A=a.indexOf("PepSeq2"),C=a.indexOf("Type");if(-1===m)alert("Failed to read column 'Protein1' from CSV file");else if(-1===n)alert("Failed to read column 'Protein2' from CSV file");else{if(-1===t&&(t=a.indexOf("AbsPos1"),-1===t)){alert("Failed to read column 'LinkPos1' from CSV file");return}if(-1===x&&(x=a.indexOf("AbsPos2"),
-1===x)){alert("Failed to read column 'LinkPos2' from CSV file");return}-1===u&&(u=a.indexOf("ld-Score"));var q=h.length;if(c){c=c.split("\n");a=null;for(var r,p,k=0;k<c.length;k++){var v=""+c[k];if(0!==v.indexOf(";"))if(0===v.indexOf(">")){if(null!==a){var B=e(a);p=new Protein(a,this,null,B);p.setSequence(r.trim());this.proteins.set(a,p);p=new Protein("decoy_reverse_"+a,this,null,"DECOY_"+B);p.setSequence(r.trim().split("").reverse().join(""));this.proteins.set("decoy_reverse_"+a,p);p=new Protein("reverse_"+
a,this,null,"DECOY_"+B);p.setSequence(r.trim().split("").reverse().join(""));this.proteins.set("reverse_"+a,p);r=""}p=v.indexOf(" ");-1===p&&(p=v.length);a=v.substring(1,p).trim().replace(/(['"])/g,"");v.substring(p).trim()}else r+=v.trim()}B=e(a);p=new Protein(a,this,null,B);p.setSequence(r.trim());this.proteins.set(a,p);p=new Protein("decoy_reverse_"+a,this,null,"DECOY_"+B);p.setSequence(r.trim().split("").reverse().join(""));this.proteins.set("decoy_reverse_"+a,p);p=new Protein("reverse_"+a,this,
null,"DECOY_"+B);p.setSequence(r.trim().split("").reverse().join(""));this.proteins.set("reverse_"+a,p);f();r=this.proteins.values();var D=r.length;for(c=0;c<D;c++)p=r[c],0===p.proteinLinks.keys().length&&this.proteins.remove(p.id);b&&g.addAnnotations(b);g.initProteins()}else{d(m);d(n);r=this.proteins.values();var D=r.length,E=0;for(c=0;c<D;c++)this.xiNET_storage.getSequence(r[c].id,function(a,c){g.proteins.get(a).setSequence(c);E++;E===D&&(b&&g.addAnnotations(b),g.initProteins())});f()}this.initLayout()}};
